<!DOCTYPE html>
{% load static %}

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Knowledge Places Map</title>


  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


<link rel="stylesheet" href="{% static 'places/styles.css' %}">







</head>

  <header class="page-header">
    Dublin Knowledge Map
  </header>
<body>
<div class="controls">
  <button id="toggle-places" class="active">Toggle Locations</button>
  <button id="toggle-highlight" class="active">Toggle Query Results</button>

  <div class="input-group">
    <label for="buffer-distance">Buffer Distance (metres)</label>
    <input type="number" id="buffer-distance" value="500" />
  </div>

  <div class="input-group">
    <label for="category-filter">Category</label>
    <select id="category-filter">
      <option value="all">All</option>
      <option value="library">Library</option>
      <option value="museum">Museum</option>
      <option value="heritage">Heritage</option>
      <option value="university">University</option>
    </select>
  </div>
</div>

<div id="map"></div>

<div class="legend">
  <strong>Legend</strong>
  <div><span class="color-box" style="background:red"></span>Library</div>
  <div><span class="color-box" style="background:blue"></span>Museum</div>
  <div><span class="color-box" style="background:orange"></span>Heritage</div>
  <div><span class="color-box" style="background:purple"></span>University</div>
  <div><span class="color-box" style="background:green"></span>Query Result</div>
  <div><span class="color-box" style="background:black"></span>Route</div>
</div>


  <script>
  const map = L.map('map').setView([53.3498, -6.2603], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  const placesLayer = L.layerGroup().addTo(map);
  const highlightedLayer = L.layerGroup().addTo(map);
  const routesLayer = L.layerGroup().addTo(map);

  const categoryColors = {
    library: 'red',
    museum: 'blue',
    heritage: 'orange',
    university: 'purple'
  };

  let allPlaces = []; // store all markers with category info

  const categoryFilter = document.getElementById('category-filter');

  // function to update KnowledgePlaces layer based on category filter
  function updatePlacesLayer() {
    placesLayer.clearLayers();
    const selectedCategory = categoryFilter.value;
    allPlaces.forEach(marker => {
      if (selectedCategory === 'all' || marker.options.category === selectedCategory) {
        marker.addTo(placesLayer);
      }
    });
  }

  // Function to update highlighted query results based on category filter
  function updateHighlightedLayer() {
    const selectedCategory = categoryFilter.value;
    highlightedLayer.eachLayer(marker => {
      if (selectedCategory === 'all' || marker.options.category === selectedCategory) {
        marker.addTo(map);
      } else {
        map.removeLayer(marker);
      }
    });
  }

  categoryFilter.addEventListener('change', () => {
    updatePlacesLayer();
    updateHighlightedLayer();
  });

  // Load KnowledgePlaces
  fetch('/api/knowledgeplaces/geojson/')
    .then(res => res.json())
    .then(data => {
      allPlaces = data.features.map(feature => {
        const category = feature.properties.category;
        return L.circleMarker(
          [feature.geometry.coordinates[1], feature.geometry.coordinates[0]],
          { color: categoryColors[category] || 'gray', radius: 6, category }
        ).bindPopup(`<b>${feature.properties.name}</b><br>${category}<br>${feature.properties.address || ''}`);
      });
      updatePlacesLayer();
    });

  // Load Routes
  fetch('/api/routes/geojson/')
    .then(res => res.json())
    .then(data => {
      data.features.forEach(feature => {
        L.geoJSON(feature, { style: { color: 'black', weight: 4 } })
          .addTo(routesLayer)
          .on('click', () => highlightPlacesNearRoute(feature.properties.id));
      });
    });

  // Toggle KnowledgePlaces
  document.getElementById('toggle-places').addEventListener('click', function() {
    if (map.hasLayer(placesLayer)) { map.removeLayer(placesLayer); this.classList.remove('active'); }
    else { map.addLayer(placesLayer); this.classList.add('active'); }
  });

  // Toggle highlighted query results
  document.getElementById('toggle-highlight').addEventListener('click', function() {
    if (map.hasLayer(highlightedLayer)) { map.removeLayer(highlightedLayer); this.classList.remove('active'); }
    else { map.addLayer(highlightedLayer); this.classList.add('active'); }
  });

  // Highlight places near route with buffer
  function highlightPlacesNearRoute(routeId) {
    highlightedLayer.clearLayers();
    const buffer = document.getElementById('buffer-distance').value || 50;

    fetch(`/api/routes/places-near/${routeId}/?buffer=${buffer}`)
      .then(res => res.json())
      .then(data => {
        data.forEach(place => {
          const coords = place.geometry.match(/POINT \((-?\d+\.\d+) (-?\d+\.\d+)\)/);
          if (!coords) return;
          const lon = parseFloat(coords[1]);
          const lat = parseFloat(coords[2]);
          const marker = L.marker([lat, lon], { category: place.category, icon: undefined })
            .bindPopup(`<b>${place.name}</b><br>${place.category}`);
          highlightedLayer.addLayer(marker);
        });
        updateHighlightedLayer();
      });
  }

  // Click map for proximity query
  map.on('click', function(e) {
    highlightedLayer.clearLayers();
    const radius = document.getElementById('buffer-distance').value || 500;

    fetch(`/api/knowledgeplaces/within_radius/?lat=${e.latlng.lat}&lon=${e.latlng.lng}&radius=${radius}`)
      .then(res => res.json())
      .then(data => {
        data.forEach(place => {
          const coords = place.geometry.match(/POINT \((-?\d+\.\d+) (-?\d+\.\d+)\)/);
          if (!coords) return;
          const lon = parseFloat(coords[1]);
          const lat = parseFloat(coords[2]);
          const marker = L.marker([lat, lon], { category: place.category })
            .bindPopup(`<b>${place.name}</b><br>${place.category}`);
          highlightedLayer.addLayer(marker);
        });
        updateHighlightedLayer();
      });
  });
  </script>
</body>
</html>
